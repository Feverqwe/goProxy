# Go HTTP Proxy Server

HTTP прокси сервер на Go, который направляет запросы через различные типы прокси (SOCKS5, HTTP, HTTPS) в зависимости от адреса назначения. Поддерживает конфигурируемые правила обхода, кеширование для производительности и интеграцию с системным треем на macOS.

## Функциональность

- **Конфигурируемые правила обхода** с поддержкой glob-паттернов:
  - IP-диапазоны (CIDR-нотация)
  - Доменные имена с glob-паттернами
  - Полные URL с путями и протоколами

- **Поддержка различных типов прокси**:
  - SOCKS5 (`socks5://`)
  - HTTP (`http://`)
  - HTTPS (`https://`)
  - Прямое соединение (без прокси)
  - **Блокировка запросов** (значение `#`)

## Установка и запуск

### Базовый запуск

1. Убедитесь, что у вас установлен Go (версия 1.21 или выше)
2. Клонируйте репозиторий и перейдите в директорию проекта
3. Установите зависимости: `go mod tidy`
4. Соберите проект: `go build -o goProxy`
5. Настройте конфигурацию в файле `config.yaml` (при необходимости)
6. Запустите прокси сервер: `./goProxy`

### Дополнительные команды

```bash
# Сборка для macOS с приложением
./scripts/build.mac.sh

# Базовая сборка для других платформ
./scripts/build.sh

# Запуск с автоматической сборкой
./scripts/run.sh

# Указать путь к конфигурационному файлу
./goProxy -config /path/to/config.yaml
```

**Для macOS**: При запуске появится иконка в системном трее с меню управления.

## Конфигурация

### Формат конфигурации

Файл конфигурации `config.yaml` содержит следующие параметры:

- `default_proxy`: ключ прокси по умолчанию
- `proxies`: словарь прокси-серверов (SOCKS5, HTTP, HTTPS, прямое соединение, блокировка)
- `listen_addr`: адрес для прослушивания (по умолчанию: `:8080`)
- `log_level`: уровень логирования (`debug`, `info`, `warn`, `error`, `none`)
- `rules`: список правил маршрутизации
- `ip_cache_size`: размер кеша IP-адресов

### Конфигурация по умолчанию

Если файл `config.yaml` не существует, используется следующая конфигурация по умолчанию:

```yaml
default_proxy: direct
proxies:
  socks5: socks5://localhost:1080
  http: http://localhost:8081
  direct: ""
  block: "#"
listen_addr: :8080
log_level: info
rules:
  - proxy: direct
    ips: "192.168.1.0/24 10.0.0.0/8"
    hosts: "localhost* *.local *.example.com"
    urls: "http://internal-api.company.com/v1/* https://*.internal.com/api/*"
  - proxy: socks5
    not: true
    hosts: "*.google.com *.youtube.com"
  - proxy: block
    hosts: "*.malicious.com *.spam.com"
ip_cache_size: 1000
```

### Правила маршрутизации

Каждое правило содержит:
- `proxy`: ключ прокси для использования
- `ips`: строка с IP-диапазонами в CIDR нотации, разделенными пробелами или запятыми
- `hosts`: строка с доменными именами с поддержкой glob-паттернов, разделенными пробелами или запятыми
- `urls`: строка с полных URL с путями и протоколами, разделенными пробелами или запятыми
- `not`: инвертировать правило (если `true`, правило применяется ко всем, кроме указанных)

### Блокировка запросов

Для блокировки запросов используйте специальное значение `#` в конфигурации прокси:

```yaml
proxies:
  block: "#"  # Блокирует все запросы, направленные через этот прокси
```

Когда запрос соответствует правилу с таким прокси:
- Возвращается HTTP статус 403 Forbidden
- Запрос логируется с пометкой "Blocking request"
- Соединение немедленно прерывается

**Пример использования для блокировки нежелательных доменов:**
```yaml
rules:
  - proxy: block
    hosts: "*.malicious.com *.spam.com *.ads.com"
```

**Приоритет проверки правил**: URL паттерны → IP-диапазоны → Домены

## Использование

Настройте приложение или браузер использовать HTTP прокси на `http://localhost:8080`.

### Пример настройки

```bash
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
curl -x http://localhost:8080 https://example.com
```

### Сигналы управления

- **SIGHUP** - перезагрузить конфигурацию
- **SIGINT/SIGTERM** - грациозное завершение работы

## Лицензия

MIT License