# Go HTTP Proxy Server

HTTP прокси сервер на Go, который направляет запросы через различные типы прокси (SOCKS5, HTTP, HTTPS) в зависимости от адреса назначения. Поддерживает конфигурируемые правила обхода, кеширование для производительности, интеграцию с системным треем.

## Функциональность

- **Конфигурируемые правила обхода** с поддержкой glob-паттернов:
  - IP-диапазоны (CIDR-нотация)
  - Доменные имена с glob-паттернами
  - Полные URL с путями и протоколами

- **Поддержка различных типов прокси**:
  - SOCKS5 (`socks5://`, `socks5h://`)
  - HTTP (`http://`)
  - HTTPS (`https://`)
  - Прямое соединение (без прокси)
  - **Блокировка запросов** (значение `#`)

- **Производительность**:
  - Кеширование DNS запросов с TTL 5 минут
  - Предварительная компиляция glob-паттернов
  - LRU кеш для часто используемых паттернов
  - Оптимизированная обработка HTTP/HTTPS запросов

## Установка и запуск

### Базовый запуск

1. Убедитесь, что у вас установлен Go (версия 1.21 или выше)
2. Клонируйте репозиторий и перейдите в директорию проекта
3. Установите зависимости: `go mod tidy`
4. Соберите проект: `go build -o goProxy`
5. Настройте конфигурацию в файле `config.yaml` (при необходимости)
6. Запустите прокси сервер: `./goProxy`

### Build windows

````
go build -ldflags -H=windowsgui -trimpath -o goProxy.exe
````

For file icon, use rsrc

````
.\rsrc_windows_amd64.exe -ico .\icon.ico -o FILE_windows.syso
````

### Дополнительные команды

```bash
# Сборка для macOS с приложением
./scripts/build.mac.sh

# Базовая сборка для других платформ
./scripts/build.sh

# Запуск с автоматической сборкой
./scripts/run.sh

# Указать путь к конфигурационному файлу
./goProxy -config /path/to/config.yaml

# Показать версию приложения
./goProxy -version
```

**Для macOS/Windows**: При запуске появится иконка в системном трее с меню управления:
- **Reload config** - перезагрузить конфигурацию без перезапуска приложения
- **Open config directory** - открыть директорию с конфигурационным файлом
- **Quit** - корректное завершение работы приложения

## Конфигурация

### Формат конфигурации

Файл конфигурации `config.yaml` содержит следующие параметры:

- `defaultProxy`: ключ прокси по умолчанию
- `proxies`: словарь прокси-серверов (SOCKS5, HTTP, HTTPS, прямое соединение, блокировка)
- `listenAddr`: адрес для прослушивания (по умолчанию: `:8080`)
- `logLevel`: уровень логирования (`debug`, `info`, `warn`, `error`, `none`)
- `rules`: список правил маршрутизации

### Конфигурация по умолчанию

Если файл `config.yaml` не существует, используется следующая конфигурация по умолчанию:

```yaml
defaultProxy: direct
proxies:
  socks5: socks5://localhost:1080
  http: http://localhost:8081
  direct: ""
  block: "#"
listenAddr: :8080
logLevel: info
rules:
  - proxy: direct
    ips: "192.168.1.0/24 10.0.0.0/8 172.16.0.0/12"
    hosts: "localhost *.local *.example.com internal.company.com"
    urls: "http://internal-api.company.com/v1/* https://*.internal.com/api/*"
  - proxy: socks5
    not: true
    hosts: "*.google.com *.youtube.com"
  - proxy: http
    hosts: "*.external.com api.*.com"
  - proxy: block
    hosts: "*.malicious.com *.spam.com"
```

Пример полной конфигурации доступен в файле [`example_config.yaml`](example_config.yaml:1).

### Правила маршрутизации

Каждое правило содержит:
- `proxy`: ключ прокси для использования
- `ips`: строка с IP-диапазонами в CIDR нотации, разделенными пробелами или запятыми
- `hosts`: строка с доменными именами с поддержкой glob-паттернов, разделенными пробелами или запятыми
- `urls`: строка с полных URL с путями и протоколами, разделенными пробелами или запятыми
- `not`: инвертировать правило (если `true`, правило применяется ко всем, кроме указанных)

### Блокировка запросов

Для блокировки запросов используйте специальное значение `#` в конфигурации прокси:

```yaml
proxies:
  block: "#"  # Блокирует все запросы, направленные через этот прокси
```

Когда запрос соответствует правилу с таким прокси:
- Возвращается HTTP статус 403 Forbidden
- Запрос логируется с пометкой "Blocking request"
- Соединение немедленно прерывается

**Пример использования для блокировки нежелательных доменов:**
```yaml
rules:
  - proxy: block
    hosts: "*.malicious.com *.spam.com *.ads.com"
```

**Приоритет проверки правил**: URL паттерны → IP-диапазоны → Домены

## Использование

Настройте приложение или браузер использовать HTTP прокси на `http://localhost:8080`.

### Пример настройки

```bash
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
curl -x http://localhost:8080 https://example.com
```

### Сигналы управления

- **SIGHUP** - перезагрузить конфигурацию
- **SIGINT/SIGTERM** - грациозное завершение работы
- **Системный трей** - управление через GUI (перезагрузка конфигурации, открытие директории конфига, выход)

## Зависимости

- **github.com/elazarl/goproxy** - HTTP прокси библиотека
- **github.com/getlantern/systray** - интеграция с системным треем
- **github.com/gobwas/glob** - поддержка glob-паттернов
- **github.com/hashicorp/golang-lru/v2** - LRU кеширование
- **github.com/skratchdot/open-golang** - открытие директорий и файлов
- **golang.org/x/net** - сетевые утилиты

## Автоматические релизы с GitHub Actions

Проект использует GitHub Actions для автоматической сборки и создания релизов при добавлении тегов.

### Процесс релиза

1. **Создание тега**:
   ```bash
   git tag v1.0.0
   git push origin v1.0.0
   ```

2. **Автоматическая сборка**: При пуше тега формата `v*` запускается workflow, который:
   - Собирает бинарные файлы для Windows, macOS и Linux
   - Создает релиз на GitHub с автоматическими заметками
   - Загружает артефакты в релиз

3. **Доступные артефакты**:
   - `goProxy.exe` - Windows исполняемый файл
   - `GoProxy.app` - macOS приложение (в архиве .zip)
   - `goProxy` - Linux бинарный файл

### Ручной запуск

Workflow также можно запустить вручную через GitHub Actions интерфейс для тестирования сборки.

### Версионирование

Приложение поддерживает версионирование через флаг `-version`:
```bash
./goProxy -version
```

Версия устанавливается через ldflags во время сборки и включает:
- Номер версии
- Хэш коммита
- Время сборки

## Лицензия

MIT License